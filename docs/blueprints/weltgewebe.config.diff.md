# Blueprint Configuration Diff

## 1. Web Service (Docker Compose)

Add a `web` service to build and serve the frontend locally.

**File:** `infra/compose/compose.prod.yml` (or similar)

```yaml
services:
  web:
    build:
      context: ../../apps/web
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - default
    environment:
      - PUBLIC_GEWEBE_API_BASE=/api
```

## 2. Web Dockerfile

Create a multi-stage build for the frontend.

**File:** `apps/web/Dockerfile`

```dockerfile
# Build Stage
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN corepack enable && pnpm install --frozen-lockfile
COPY . .
# Adapters: use adapter-node or adapter-static (with fallback)
RUN pnpm build

# Run Stage (Node adapter example)
FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/build ./build
COPY --from=builder /app/package.json ./package.json
CMD ["node", "build"]
```

*Note:* If using `adapter-static`, use Caddy/Nginx image for run stage.

## 3. Caddy Routing

Update Caddy to proxy to the local web container instead of Cloudflare.

**File:** `infra/caddy/Caddyfile`

```caddy
:8081 {
  # ...
  handle_path /api/* {
    reverse_proxy api:8080
  }

  # Serve local UI
  reverse_proxy web:3000
}
```

## 4. Frontend Config Injection

Ensure `env.js` is generated or environment variables are baked in at runtime.
For `adapter-node`, `PUBLIC_` env vars are baked at build time usually,
but `ORIGIN` and `BODY_SIZE_LIMIT` etc are runtime.
For runtime config of API URL in static build, we need `window.env` injection in `index.html`.

**Recommendation:** Use `adapter-node` for easier environment handling in container,
OR use `adapter-static` + `env.js` generated by entrypoint script.

## Diagnose-Only Section (Next Steps)

Check these files to verify assumptions:

1. `apps/web/svelte.config.js` (Check adapter type: static vs node).

   ```bash
   rg "adapter" apps/web/svelte.config.js
   ```

2. `apps/api/src/routes/auth.rs` (Check implemented routes).

   ```bash
   rg "route" apps/api/src/routes/auth.rs
   ```

3. `infra/compose/compose.heimserver.override.yml` (Check conflicting ports/mounts).

4. `infra/caddy/Caddyfile` (Verify upstream config).

> **Humor:** Why did the developer go broke? Because he used Cloudflare cache for everything,
> even his bank account balance. (Stale reads are expensive.)
